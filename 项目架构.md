# 智能文档问答系统 - 项目架构

## 项目概述

已成功创建完整的智能文档问答系统，采用前后端分离架构，基于RAG（检索增强生成）技术实现文档智能问答功能。

## 已完成功能

### 1. 后端服务（Spring Boot）

#### 1.1 网关服务 (gateway)
- ✅ Spring Cloud Gateway路由转发
- ✅ Token认证拦截器
- ✅ 跨域配置
- ✅ 白名单路径配置

#### 1.2 文件管理服务 (file-service)
- ✅ 文件上传（支持doc/docx/txt/ppt/pptx/pdf）
- ✅ MinIO文件存储集成
- ✅ 文件元数据管理
- ✅ 文件列表查询
- ✅ 文件删除功能
- ✅ 文件格式校验

#### 1.3 文档解析服务 (document-service)
- ✅ 多格式文档解析（POI + PDFBox）
- ✅ 文本提取和清洗
- ✅ 异步文档解析
- ✅ 文本分片处理
- ✅ 向量化处理
- ✅ Milvus向量存储
- ✅ Elasticsearch关键词索引构建

#### 1.4 对话管理服务 (chat-service)
- ✅ 智能问答接口
- ✅ 混合检索集成（Elasticsearch + Milvus）
- ✅ BGE-Reranker重排序
- ✅ 大模型对话生成
- ✅ 对话历史管理
- ✅ Redis缓存对话上下文
- ✅ 文档问答 vs 通用问答切换

#### 1.5 权限管理服务 (auth-service)
- ✅ 用户登录/注册
- ✅ Token生成和验证
- ✅ Redis Token存储
- ✅ 用户信息管理

#### 1.6 AI引擎模块 (ai-engine)
- ✅ 文本预处理和清洗
- ✅ 智能文本分片（200-500字符/块，支持重叠分块）
- ✅ 文本向量化服务
- ✅ Milvus向量数据库集成
- ✅ Elasticsearch关键词检索集成
- ✅ 混合检索服务（HybridRetrievalService）
- ✅ 查询路由分析（关键词主导 vs 语义意图主导）
- ✅ BGE-Reranker重排序服务
- ✅ DeepSeek LLM集成
- ✅ RAG Prompt工程
- ✅ 增强检索服务（EnhancedRetrievalService）

#### 1.7 公共模块 (common)
- ✅ 统一返回结果封装
- ✅ 全局异常处理
- ✅ Redis配置
- ✅ MyBatis Plus配置
- ✅ 基础实体类

### 2. 前端应用 (Vue 3)

#### 2.1 用户界面
- ✅ 登录/注册页面
- ✅ 文件上传组件
- ✅ 文件列表展示
- ✅ 智能对话窗口
- ✅ 对话历史展示
- ✅ 文件状态显示

#### 2.2 功能特性
- ✅ 文件上传（支持多格式）
- ✅ 文档解析状态跟踪
- ✅ 实时对话交互
- ✅ 对话上下文保持
- ✅ 回答来源标识
- ✅ 响应式布局

### 3. 数据存储

#### 3.1 MySQL数据库
- ✅ 用户表（user）
- ✅ 文档表（document）
- ✅ 对话消息表（chat_message）
- ✅ 初始化SQL脚本

#### 3.2 Redis缓存
- ✅ Token存储
- ✅ 对话历史缓存
- ✅ 配置类封装

#### 3.3 MinIO对象存储
- ✅ 文件上传服务
- ✅ 文件下载服务
- ✅ Bucket管理

#### 3.4 Milvus向量数据库
- ✅ 集合创建和管理
- ✅ 向量插入
- ✅ 向量相似度搜索
- ✅ 索引创建

#### 3.5 Elasticsearch全文搜索引擎
- ✅ 索引创建和管理
- ✅ 文档块索引（支持IK分词器）
- ✅ 关键词检索（多字段搜索）
- ✅ 按文档ID删除索引

## 技术架构

```
前端 (Vue 3 + Element Plus)
    ↓
网关 (Spring Cloud Gateway)
    ↓
业务服务层
    ├── 文件管理服务
    ├── 文档解析服务
    ├── 对话管理服务
    └── 权限管理服务
    ↓
AI引擎层
    ├── 文本预处理
    ├── 文本分片
    ├── 向量化
    ├── 混合检索
    │   ├── Elasticsearch关键词检索
    │   ├── Milvus向量检索
    │   ├── 查询路由分析
    │   ├── 结果融合
    │   └── BGE-Reranker重排序
    └── 大模型生成
    ↓
数据存储层
    ├── MySQL (元数据)
    ├── Redis (缓存)
    ├── MinIO (文件)
    ├── Milvus (向量存储)
    └── Elasticsearch (关键词索引)
```

## 核心业务流程

### 文档上传流程
1. 用户上传文档 → 文件管理服务
2. 文件存入MinIO → 记录元数据到MySQL
3. 触发文档解析服务
4. 文档解析 → 文本提取 → 清洗 → 分片
5. 并行构建索引
   - 文本向量化 → 存入Milvus（向量索引）
   - 文档块索引 → 存入Elasticsearch（关键词索引）
6. 更新文档状态为"解析完成"

### 智能问答流程（混合检索）
1. 用户提问 → 对话管理服务
2. 查询路由分析（判断关键词主导 vs 语义意图主导）
3. 并行检索
   - Elasticsearch关键词检索（Top N）
   - Milvus向量检索（Top N）
4. 结果融合（加权合并两种检索结果）
5. BGE-Reranker重排序（精排Top K）
6. 结果去重
7. 判断是否有相关文档内容
   - 有：RAG模式（基于文档内容回答）
   - 无：通用模式（AI自由回答）
8. 调用DeepSeek生成回答
9. 保存对话历史
10. 返回回答给前端

**回退机制**：
- 优先使用混合检索（ES + Milvus + Reranker）
- ES不可用时回退到增强检索（EnhancedRetrievalService）
- 都不可用时回退到基础向量检索

## 项目结构

```
smart-doc-qa/
├── backend/                    # 后端服务
│   ├── gateway/               # 网关服务 (8080)
│   ├── file-service/         # 文件管理服务 (8081)
│   ├── document-service/      # 文档解析服务 (8082)
│   ├── chat-service/          # 对话管理服务 (8083)
│   ├── auth-service/          # 权限管理服务 (8084)
│   ├── ai-engine/             # AI引擎模块
│   └── common/                # 公共模块
├── frontend/                  # 前端应用 (3000)
│   ├── src/
│   │   ├── api/              # API接口
│   │   ├── views/            # 页面组件
│   │   ├── router/           # 路由配置
│   │   └── main.js           # 入口文件
│   └── package.json
├── sql/                       # 数据库脚本
│   └── init.sql              # 初始化SQL
├── README.md                  # 项目说明
├── DEPLOYMENT.md             # 部署指南
└── PROJECT_SUMMARY.md        # 项目总结
```

## 配置说明

### 必需配置项

1. **数据库配置**（所有服务）
   - MySQL连接信息
   - Redis连接信息

2. **MinIO配置**（文件服务、文档解析服务）
   - Endpoint
   - Access Key / Secret Key
   - Bucket名称

3. **Milvus配置**（文档解析服务、对话服务）
   - Host / Port
   - Collection名称

4. **Elasticsearch配置**（文档解析服务、对话服务）
   - Host / Port
   - Index名称
   - IK分词器（中文必需）

5. **BGE-Reranker配置**（对话服务，可选）
   - 是否启用
   - API URL

6. **AI服务配置**
   - Embedding API URL和模型
   - DeepSeek API Key和模型

### 默认配置

- MySQL: localhost:3306
- Redis: localhost:6379
- MinIO: localhost:9000
- Milvus: localhost:19530
- Elasticsearch: localhost:9200
- 网关: localhost:8080
- 前端: localhost:3000

## 测试账号

- 管理员：admin / admin123
- 测试用户：test / test123

## 下一步优化建议

1. **性能优化**
   - 文档解析异步队列（RabbitMQ/Kafka）
   - 向量检索结果缓存
   - 大文件分片上传

2. **功能扩展**
   - 多文档联合问答
   - 文档内容高亮
   - 问答导出功能
   - 文档分类管理
   - 用户权限细化

3. **系统优化**
   - 服务注册发现（Nacos/Eureka）
   - 配置中心
   - 链路追踪
   - 监控告警

4. **安全增强**
   - 密码加密存储
   - JWT Token
   - 接口限流
   - 文件类型深度校验

## 注意事项

1. **Embedding服务**：需要单独部署Embedding API服务，或使用云服务
2. **DeepSeek API**：需要申请API Key并配置
3. **Milvus版本**：建议使用2.3.x版本，已测试兼容
4. **Elasticsearch**：
   - 建议使用7.17.9版本
   - 必须安装IK分词器插件（中文分词必需）
   - 如果ES不可用，系统会自动回退到增强检索或基础向量检索
5. **BGE-Reranker**：可选组件，不启用时使用综合分数排序
6. **内存数据库**：MySQL建议使用内存型数据库以提高性能
7. **生产环境**：建议使用Docker容器化部署，便于管理

## 核心技术亮点

### 混合检索系统
- **Elasticsearch关键词检索**：支持精确的关键词匹配和全文搜索
- **Milvus向量检索**：支持语义相似度搜索
- **查询路由**：根据查询特征自动调整两种检索的权重
- **BGE-Reranker重排序**：使用交叉编码器模型进行精排
- **多级回退机制**：确保系统稳定运行

### RAG优化策略
- **重叠分块**：避免边界信息丢失
- **混合检索**：结合关键词和语义检索优势
- **重排序**：提高检索结果相关性
- **去重**：避免返回重复信息

## 技术支持

如有问题，请查看：
- README.md - 项目说明
- DEPLOYMENT.md - 部署指南
- backend/HYBRID_RETRIEVAL_GUIDE.md - 混合检索系统指南
- 各服务的application.yml - 配置说明

