# RAG检索优化方案

## 问题分析

RAG检索不准确的主要问题：
1. **检索到不相关文本**：向量检索可能返回语义相似但实际不相关的内容
2. **检索到重复/冲突信息**：多个文本块包含相同或冲突的信息
3. **遗漏含有关键词的段落**：纯向量检索可能遗漏包含关键词但语义距离较远的段落
4. **未能理解问题真实意图**：单一检索策略无法全面理解用户意图

## 解决方案

### 1. 混合检索（Hybrid Search）

**实现位置**：`EnhancedRetrievalService.enhancedSearch()`

**策略**：
- **向量检索**：基于语义相似度检索（60%权重）
- **关键词检索**：基于BM25或关键词匹配（40%权重）
- **查询扩展检索**：对扩展后的查询进行向量检索

**优势**：
- 结合语义理解和关键词匹配，提高检索准确性
- 避免遗漏包含关键词但语义距离较远的段落

### 2. 查询扩展（Query Expansion）

**实现位置**：`EnhancedRetrievalService.expandQuery()`

**策略**：
- 提取查询中的关键词
- 为每个关键词生成查询变体
- 使用扩展查询进行多路检索

**优势**：
- 捕获用户意图的不同表达方式
- 提高召回率

### 3. 重排序（Reranking）

**实现位置**：`EnhancedRetrievalService.rerankResults()`

**评分因素**：
- **向量相似度分数**（40%）：基于向量距离的相似度
- **关键词匹配分数**（30%）：查询关键词在内容中的匹配度
- **位置分数**（10%）：优先选择文档前面的内容
- **内容长度分数**（10%）：适中的长度（200-500字符）更好
- **查询完整性分数**（10%）：包含完整查询短语的加分

**优势**：
- 综合考虑多个因素，提高结果相关性
- 优先返回最相关的内容

### 4. 结果去重（Deduplication）

**实现位置**：`EnhancedRetrievalService.deduplicateResults()`

**策略**：
- 使用Jaccard相似度计算文本块之间的相似度
- 去除相似度 > 0.8 的重复结果
- 保留分数最高的结果

**优势**：
- 避免返回重复信息
- 减少上下文中的冗余内容

### 5. 改进分块策略（Overlapping Chunks）

**实现位置**：`TextPreprocessService.splitText()`

**改进**：
- 添加重叠分块（默认50字符重叠）
- 避免边界信息丢失
- 保持语义完整性

**优势**：
- 避免重要信息在分块边界处被截断
- 提高检索的完整性

## 使用方式

### 自动启用

系统会自动使用增强检索服务（如果可用）。在 `ChatService` 中：

```java
if (enhancedRetrievalService != null) {
    // 使用增强检索
    searchResults = enhancedRetrievalService.enhancedSearch(question, documentId, 5);
} else {
    // 回退到基础向量检索
    searchResults = milvusService.searchSimilar(questionVector, 5, documentId);
}
```

### 配置参数

可以在 `application.yml` 中配置相关参数：

```yaml
rag:
  retrieval:
    # 检索Top K数量
    top-k: 5
    # 重叠分块大小
    chunk-overlap: 50
    # 最小分块大小
    min-chunk-size: 200
    # 最大分块大小
    max-chunk-size: 500
```

## 性能优化建议

1. **缓存查询扩展结果**：对常见查询的扩展结果进行缓存
2. **异步处理**：重排序和去重可以异步处理
3. **批量处理**：对多个查询进行批量检索

## 进一步优化方向

1. **使用专业重排序模型**：集成如BGE-Reranker等专业重排序模型
2. **集成Elasticsearch**：使用Elasticsearch进行更强大的关键词检索
3. **查询意图识别**：使用NLP技术识别查询意图，选择不同的检索策略
4. **多轮对话优化**：基于对话历史优化检索策略
5. **A/B测试**：对比不同检索策略的效果

## 测试建议

1. **准确性测试**：测试检索结果的相关性
2. **召回率测试**：测试是否遗漏重要信息
3. **性能测试**：测试检索速度
4. **用户体验测试**：测试最终问答质量

