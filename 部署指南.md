# 智能文档问答系统 - 部署指南

## 环境要求

### 基础环境
- JDK 8+
- Maven 3.6+
- Node.js 16+
- MySQL 8.0
- Redis 6.0+

### 中间件
- MinIO（对象存储）
- Milvus（向量数据库）

## 部署步骤

### 1. 数据库初始化

```bash
# 登录MySQL
mysql -u root -p

# 执行初始化脚本
source sql/init.sql
```

### 2. 启动MinIO

```bash
# 下载MinIO
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio

# 启动MinIO
./minio server /data/minio --console-address ":9001"
```

默认账号密码：minioadmin / minioadmin

### 3. 启动Milvus

使用Docker启动Milvus：

```bash
# 下载docker-compose.yml
wget https://github.com/milvus-io/milvus/releases/download/v2.3.4/milvus-standalone-docker-compose.yml -O docker-compose.yml

# 启动
docker-compose up -d
```

### 4. 启动Redis

```bash
# 使用Docker
docker run -d -p 6379:6379 redis:6.0

# 或本地安装
redis-server
```

### 5. 配置Embedding服务

系统需要Embedding API服务，可以选择：

**方案1：使用开源Embedding模型**
- 部署sentence-transformers服务
- 或使用ollama等本地模型服务

**方案2：使用云服务API**
- OpenAI Embedding API
- 或其他兼容OpenAI格式的API

修改配置文件中的 `ai.embedding.api-url` 和 `ai.embedding.model`

### 6. 配置DeepSeek API

在以下配置文件中设置DeepSeek API Key：
- `backend/document-service/src/main/resources/application.yml`
- `backend/chat-service/src/main/resources/application.yml`

```yaml
ai:
  llm:
    api-url: https://api.deepseek.com/v1/chat/completions
    api-key: your-deepseek-api-key
    model: deepseek-chat
```

### 7. 编译后端项目

```bash
cd backend
mvn clean install -DskipTests
```

### 8. 启动后端服务

按以下顺序启动服务：

```bash
# 1. 启动网关（端口8080）
cd gateway
mvn spring-boot:run

# 2. 启动文件服务（端口8081）
cd ../file-service
mvn spring-boot:run

# 3. 启动文档解析服务（端口8082）
cd ../document-service
mvn spring-boot:run

# 4. 启动对话服务（端口8083）
cd ../chat-service
mvn spring-boot:run

# 5. 启动权限服务（端口8084）
cd ../auth-service
mvn spring-boot:run
```

### 9. 启动前端

```bash
cd frontend
npm install
npm run dev
```

前端访问地址：http://localhost:3000

## 配置文件说明

### 数据库配置
所有服务的 `application.yml` 中需要配置：
- MySQL连接信息
- Redis连接信息

### MinIO配置
文件服务和文档解析服务需要配置：
- MinIO endpoint
- Access Key / Secret Key
- Bucket名称

### Milvus配置
文档解析服务和对话服务需要配置：
- Milvus host / port
- Collection名称

## 验证部署

1. 访问前端：http://localhost:3000
2. 使用测试账号登录：
   - 用户名：test
   - 密码：test123
3. 上传一个文档（doc/txt/ppt/pdf）
4. 等待文档解析完成
5. 在对话窗口提问

## 常见问题

### 1. 文档解析失败
- 检查MinIO是否正常运行
- 检查Milvus是否正常运行
- 检查Embedding API是否可访问

### 2. 问答无响应
- 检查DeepSeek API Key是否正确
- 检查网络连接
- 查看服务日志

### 3. 向量检索无结果
- 确认文档已成功解析并向量化
- 检查Milvus集合是否已创建
- 查看Milvus日志

## 生产环境建议

1. **使用Nginx反向代理**：统一入口，负载均衡
2. **使用消息队列**：文档解析异步处理
3. **配置HTTPS**：保证数据传输安全
4. **数据库主从**：提高可用性
5. **Redis集群**：提高缓存性能
6. **MinIO集群**：提高文件存储可靠性
7. **Milvus集群**：提高向量检索性能
8. **监控告警**：使用Prometheus + Grafana

