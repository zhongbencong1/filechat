# 配置管理指南

## 配置统一管理

所有服务的公共配置已统一管理在 `backend/common/src/main/resources/application-common.yml` 文件中。

## 配置结构

### 1. 公共配置文件
- **位置**: `backend/common/src/main/resources/application-common.yml`
- **用途**: 包含所有服务共享的配置（MySQL、Redis、MinIO、Milvus、AI服务等）

### 2. 服务特定配置
- **位置**: 各服务的 `src/main/resources/application.yml`
- **用途**: 包含服务特定的配置（端口、服务名、MyBatis包路径等）

## 配置项说明

### MySQL配置
```yaml
spring:
  datasource:
    url: jdbc:mysql://${MYSQL_HOST:localhost}:${MYSQL_PORT:3306}/${MYSQL_DATABASE:smart_doc_qa}...
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:root}
```

**环境变量**:
- `MYSQL_HOST`: MySQL主机地址（默认: localhost）
- `MYSQL_PORT`: MySQL端口（默认: 3306）
- `MYSQL_DATABASE`: 数据库名（默认: smart_doc_qa）
- `MYSQL_USERNAME`: 用户名（默认: root）
- `MYSQL_PASSWORD`: 密码（默认: root）

### Redis配置
```yaml
spring:
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    database: ${REDIS_DATABASE:0}
    password: ${REDIS_PASSWORD:}
```

**环境变量**:
- `REDIS_HOST`: Redis主机地址（默认: localhost）
- `REDIS_PORT`: Redis端口（默认: 6379）
- `REDIS_DATABASE`: 数据库索引（默认: 0）
- `REDIS_PASSWORD`: 密码（默认: 空）

### MinIO配置
```yaml
minio:
  endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
  access-key: ${MINIO_ACCESS_KEY:minioadmin}
  secret-key: ${MINIO_SECRET_KEY:minioadmin}
  bucket: ${MINIO_BUCKET:documents}
```

**环境变量**:
- `MINIO_ENDPOINT`: MinIO服务地址（默认: http://localhost:9000）
- `MINIO_ACCESS_KEY`: 访问密钥（默认: minioadmin）
- `MINIO_SECRET_KEY`: 秘密密钥（默认: minioadmin）
- `MINIO_BUCKET`: 存储桶名称（默认: documents）

### Milvus配置
```yaml
milvus:
  host: ${MILVUS_HOST:localhost}
  port: ${MILVUS_PORT:19530}
  collection: ${MILVUS_COLLECTION:document_vectors}
  timeout: ${MILVUS_TIMEOUT:30000}
```

**环境变量**:
- `MILVUS_HOST`: Milvus主机地址（默认: localhost）
- `MILVUS_PORT`: Milvus端口（默认: 19530）
- `MILVUS_COLLECTION`: 集合名称（默认: document_vectors）
- `MILVUS_TIMEOUT`: 超时时间（默认: 30000ms）

### AI服务配置

#### Embedding配置
```yaml
ai:
  embedding:
    api-url: ${EMBEDDING_API_URL:http://localhost:8000/v1/embeddings}
    model: ${EMBEDDING_MODEL:text-embedding-ada-002}
    timeout: ${EMBEDDING_TIMEOUT:30000}
    dimension: ${EMBEDDING_DIMENSION:768}
```

**环境变量**:
- `EMBEDDING_API_URL`: Embedding API地址
- `EMBEDDING_MODEL`: Embedding模型名称
- `EMBEDDING_TIMEOUT`: 超时时间（默认: 30000ms）
- `EMBEDDING_DIMENSION`: 向量维度（默认: 768）

#### LLM配置
```yaml
ai:
  llm:
    api-url: ${LLM_API_URL:https://api.deepseek.com/v1/chat/completions}
    api-key: ${LLM_API_KEY:your-deepseek-api-key}
    model: ${LLM_MODEL:deepseek-chat}
    timeout: ${LLM_TIMEOUT:60000}
    max-tokens: ${LLM_MAX_TOKENS:2000}
    temperature: ${LLM_TEMPERATURE:0.7}
```

**环境变量**:
- `LLM_API_URL`: LLM API地址
- `LLM_API_KEY`: API密钥（**必须配置**）
- `LLM_MODEL`: 模型名称（默认: deepseek-chat）
- `LLM_TIMEOUT`: 超时时间（默认: 60000ms）
- `LLM_MAX_TOKENS`: 最大token数（默认: 2000）
- `LLM_TEMPERATURE`: 温度参数（默认: 0.7）

## 使用方式

### 方式1: 使用环境变量（推荐）

在启动服务前设置环境变量：

**Linux/Mac**:
```bash
export MYSQL_HOST=192.168.1.100
export MYSQL_PASSWORD=mypassword
export LLM_API_KEY=sk-your-api-key
java -jar file-service.jar
```

**Windows**:
```cmd
set MYSQL_HOST=192.168.1.100
set MYSQL_PASSWORD=mypassword
set LLM_API_KEY=sk-your-api-key
java -jar file-service.jar
```

### 方式2: 使用application.yml覆盖

在各服务的 `application.yml` 中直接覆盖配置：

```yaml
spring:
  datasource:
    url: jdbc:mysql://192.168.1.100:3306/smart_doc_qa...
    password: mypassword

ai:
  llm:
    api-key: sk-your-api-key
```

### 方式3: 使用application-{profile}.yml

创建环境特定的配置文件，如 `application-prod.yml`：

```yaml
spring:
  datasource:
    password: ${MYSQL_PASSWORD}
  
ai:
  llm:
    api-key: ${LLM_API_KEY}
```

启动时指定profile：
```bash
java -jar file-service.jar --spring.profiles.active=prod
```

## 配置属性类

代码中可以使用配置属性类来访问配置：

```java
@Autowired
private MinioProperties minioProperties;

@Autowired
private AIProperties aiProperties;
```

可用的配置属性类：
- `DatabaseProperties` - 数据库配置
- `RedisProperties` - Redis配置
- `MinioProperties` - MinIO配置
- `MilvusProperties` - Milvus配置
- `AIProperties` - AI服务配置

## 注意事项

1. **敏感信息**: 密码、API密钥等敏感信息建议使用环境变量，不要硬编码在配置文件中
2. **默认值**: 所有配置都有默认值，适合本地开发环境
3. **覆盖顺序**: 环境变量 > application-{profile}.yml > application.yml > application-common.yml
4. **配置加载**: 各服务通过 `spring.profiles.include: common` 自动加载公共配置

## 快速配置检查清单

- [ ] MySQL连接信息
- [ ] Redis连接信息
- [ ] MinIO连接信息
- [ ] Milvus连接信息
- [ ] Embedding API地址和模型
- [ ] LLM API地址和密钥（**必须配置**）

